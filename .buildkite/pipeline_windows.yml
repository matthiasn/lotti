steps:
  - group: "Windows codegen & test"
    key: "windows_codegen_test"
    steps:
      - label: ":windows: ðŸ›  Clean "
        key: "windows_clean"
        commands:
          - "flutter clean"
        agents:
          os: "windows"

      - label: ":windows: ðŸ›  Dependencies "
        key: "windows_deps"
        depends_on:
          - "windows_clean"
        commands:
          - "flutter pub get"
          - "robocopy . c:\\buildkite-agent\\tmp\\${BUILDKITE_COMMIT}\\ /mir"
        soft_fail:
          - exit_status: 1
        agents:
          os: "windows"

      - label: ":windows: ðŸ›  Codegen "
        key: "windows_build_runner"
        depends_on:
          - "windows_deps"
        commands:
          - "robocopy c:\\buildkite-agent\\tmp\\${BUILDKITE_COMMIT}\\ . /mir"
          - "flutter pub run build_runner build --delete-conflicting-outputs"
          - "robocopy . c:\\buildkite-agent\\tmp\\${BUILDKITE_COMMIT}\\ /mir"
        soft_fail:
          - exit_status: 1
        agents:
          os: "windows"

      - label: ":windows: ðŸ”¬ Test "
        key: "windows_test"
        depends_on:
          - "windows_build_runner"
        commands:
          - "robocopy c:\\buildkite-agent\\tmp\\${BUILDKITE_COMMIT}\\ . /mir"
          - "flutter test"
        soft_fail:
          - exit_status: 1
        agents:
          os: "windows"

  #################

  - label: ":windows: ðŸ›  Build "
    key: "windows_build"
    depends_on:
      - "windows_codegen_test"
    commands:
      - "robocopy c:\\buildkite-agent\\tmp\\${BUILDKITE_COMMIT}\\ . /mir"
      - "flutter build windows -v"
      - "robocopy . c:\\buildkite-agent\\tmp\\${BUILDKITE_COMMIT}\\ /mir"
    soft_fail:
      - exit_status: 1
    agents:
      os: "windows"

  - label: ":github: MSIX ðŸ“¦"
    key: "windows_msix"
    depends_on:
      - "windows_build"
    commands:
      - "robocopy c:\\buildkite-agent\\tmp\\${BUILDKITE_COMMIT}\\ . /mir"
      - "flutter pub run msix:create"
    soft_fail:
      - exit_status: 1
    agents:
      os: "windows"
