# Upgrade to freezed 3.x — Implementation Plan

Date: 2025-09-13  
Owner: AI Assistant  
Status: Ready

## Targets
- `freezed_annotation: ^3.1.0`
- `freezed: ^3.2.3`

Environment notes
- Flutter via FVM: `.fvmrc` → `3.35.3` (satisfies Dart ≥ 3.8 required by newer freezed releases).
- Current repo uses `freezed_annotation: ^2.0.3` and `freezed: ^2.5.2`.
- Analyzer Zero‑Warning policy applies; no ignores in production code.

## Executive Summary
Upgrade the project from Freezed v2 to v3, adopt the new requirements (`abstract`/`sealed`), and migrate usages of `.map/.when` to Dart pattern matching. For cross‑library unions, ensure public union case classes to enable pattern matching without relying on private `_Case` types. Regenerate code and verify green analyzer + tests.

## Plan
1) Bump dependencies (pubspec)
   - Update to `freezed_annotation: ^3.1.0`, `freezed: ^3.2.3`.
   - If needed, allow minor bumps to `build_runner`, `json_serializable`, `source_gen` (transitive) during `pub upgrade`.

2) Add required keywords (`abstract` / `sealed`)
   - For data classes (single factory): use `abstract class`.
   - For unions (two or more `const factory Class.case(...)`): use `sealed class`.
   - Do not touch generated files; only update source declarations.

3) Ensure public union case classes where used across libraries
   - Prefer public case classes (e.g., `= TaskOpen;`) over private (e.g., `= _TaskOpen;`) so pattern matching works outside the defining library.
   - TagEntity, EntityDefinition, HabitSchedule, AutoCompleteRule, SyncMessage already use public cases. Convert `TaskStatus` (and any similar exceptions) to public cases.

4) Replace `.map/.maybeMap` and `.when/.maybeWhen` on Freezed unions
   - Use Dart pattern matching:
     - Example (before): `status.map(open: (_) => 'OPEN', done: (_) => 'DONE')`
     - Example (after):
       ```dart
       switch (status) {
         case TaskOpen(): return 'OPEN';
         case TaskDone(): return 'DONE';
         // ...
       }
       ```
   - Where code previously matched on private `_Case` types from another file, first rename union case classes to public (step 3).

5) Regenerate and iterate
   - Run codegen, analyzer, and tests; fix findings until green.

6) Final verification
   - Ensure zero analyzer warnings, all tests pass, and CI scripts (`make analyze`, `make test`) succeed.

## Repository Impact (scoped observations)
- `@freezed` declarations without `abstract/sealed`: many across `lib/` (states, models). Unions confirmed include: `TaskStatus`, `TagEntity`, `EntityDefinition`, `HabitSchedule`, `AutoCompleteRule`, `JournalEntity`, `QuantitativeData`, `SyncMessage`, `AiConfig`, etc.
- Private union case classes observed: `TaskStatus` uses `_TaskOpen/_TaskDone/...`; others already public (e.g., `GenericTag`, `CategoryDefinition`, `SyncJournalEntity`). Plan: make `TaskStatus` cases public.
- Frequent uses of `.map/.when` on unions in UI/controllers (e.g., `TagEntity`, `TaskStatus`, `SyncMessage`). These must switch to `switch` with patterns.

Suggested searches
- Find Freezed classes to update: `rg -n "@freezed$" lib`
- Find unions (≥2 factories): `rg -n "const factory [A-Za-z0-9_]+\." lib`
- Find `.map/.maybeMap`: `rg -n "\.(maybe)?map\(" lib`
- Find `.when/.maybeWhen`: `rg -n "\.(maybe)?when\(" lib`
- Find private case classes: `rg -n "= _[A-Z][A-Za-z0-9_]*;" lib`

## Step‑by‑Step with MCP
- Add repo root once: `dart-mcp.add_roots` → workspace URI.
- Upgrade packages:
  - Edit `pubspec.yaml` (see Targets) and run `dart-mcp.pub` → `get` then `upgrade`.
- Generate code:
  - `dart run build_runner build` (or `make build_runner`).
- Analyze, format, test (iterate):
  - `dart-mcp.analyze_files` until zero warnings.
  - `dart-mcp.dart_format` to normalize diffs.
  - `dart-mcp.run_tests` (start with targeted files, then full suite).
  - For references while coding, use Context7 (`context7.resolve-library-id` → `context7.get-library-docs`) to fetch the latest freezed docs/changelog.

## Concrete Changes (examples)
- Add `sealed`/`abstract`:
  ```diff
  @freezed
- class SyncMessage with _$SyncMessage {
+ sealed class SyncMessage with _$SyncMessage {
  ```

- Make union cases public (TaskStatus):
  ```diff
  @freezed
- class TaskStatus with _$TaskStatus {
+ sealed class TaskStatus with _$TaskStatus {
    const factory TaskStatus.open({ ... }) = TaskOpen;
  - const factory TaskStatus.done({ ... }) = _TaskDone;
  + const factory TaskStatus.done({ ... }) = TaskDone;
  }
  // Then replace pattern matches on `_TaskDone()` with `TaskDone()`
  ```

- Replace `.map` usages:
  ```diff
  - final color = status.map(
  -   open: (_) => Colors.orange,
  -   done: (_) => Colors.green,
  - );
  + final color = switch (status) {
  +   TaskOpen() => Colors.orange,
  +   TaskDone() => Colors.green,
  +   _ => Colors.red,
  + };
  ```

- Replace `.when` usages:
  ```diff
  - await syncMessage.when(
  -   journalEntity: (id, jsonPath, vectorClock, status) => ...,
  -   entityDefinition: (def, status) => ...,
  - );
  + switch (syncMessage) {
  +   case SyncJournalEntity(:final id, :final jsonPath, :final vectorClock, :final status):
  +     ...
  +   case SyncEntityDefinition(:final entityDefinition, :final status):
  +     ...
  + }
  ```

## Validation / Acceptance Criteria
- `make analyze` reports zero warnings/infos.
- `make test` passes; no test cases removed. If test files are edited, scenarios/assertions preserved.
- `dart run build_runner build` completes without generator errors.
- App builds and runs on a local device (`fvm flutter run -d <device>`).

## Risks / Mitigations
- Widespread `.map/.when` usage: perform in focused PR(s) with targeted diffs; convert high‑traffic unions first (e.g., `SyncMessage`, `TaskStatus`).
- Private union cases: standardize to public to avoid leaking `_Case` across files.
- Analyzer updates: `freezed` v3 aligns to newer analyzer; if analyzer constraints block, bump dev dependency `analyzer` to `^7.5.9+` as needed.
- build_runner/source_gen compatibility: if conflicts arise, bump `build_runner` and `json_serializable` to latest compatible.

## Rollout Strategy
- Branch: `chore/freezed-3`.
- Phase 1: pubspec bump + add `abstract/sealed` (no behavior change), regen, analyze.
- Phase 2: publicize remaining private union cases, replace `.map/.when` for those types, run tests.
- Phase 3: remaining `.map/.when` sites, run full tests, stabilize.

---

Appendix — Upstream Notes

Here's the excerpt of the CHANGELOG for the latest changes:

## 3.2.3 - 2025-09-10

Broader the version range for `analyzer`/`source_gen`/`build`

## 3.2.2 - 2025-09-09

Bump `build`

## 3.2.1 - 2025-09-09

Support latest analyzer/source_gen

## 3.2.0 - 2025-07-18

- Use `build` 3.0.0-dev.
- Use `source_gen` 3.0.0-dev.
- Support Dart 3.8.0 and analyzer 7.5.9 as a minumum.

## 3.1.0 - 2025-07-02

- Added `when`/`map` back
- Stop writing `// dart format width=80` to the generated freezed files.

## 3.0.6 - 2025-04-05

Remove logs

## 3.0.5 - 2025-04-05

- Fix ==/hashCode when using inheritance.
  The generated ==/hashCode now call `super == other` when necessary.
- Fix an issue with `Diagnosticable` and `toString`
- Fix ejecting union cases when more than one class is defined in a file
- Fix a copyWith bug when a constructor parameter has no matching property
- Fix null exception in some cases when using generic classes and copyWith

## 3.0.4 - 2025-03-16

- Update docs (thanks to @lishaduck)
- Support Dart 3.6.0 and analyzer 6.9.0 as a minimum.

## 3.0.3 - 2025-03-02

Update readme (thanks to @snapsl)

## 3.0.2 - 2025-02-27

- Fix various deep-copy bugs
- Throw when using `extends`/`with` but not specifying a `MyClass._()` constructor
- Throw when a Freezed class forgot to include `with _$MyClass`
- "Normal" classes shouldn't require `MyClass._()` when they define getters/methods/...

## 3.0.1 - 2025-02-27

Fix a bug with diagnosticable objects.

## 3.0.0 - 2025-02-25

### New: Mixed mode

Freezed 3.0 is about supporting a "mixed mode".  
From now on, Freezed supports both the usual syntax:

```dart
@freezed
sealed class Usual with _$Usual {
  factory Usual({int a}) = _Usual;
}
```

But also:

```dart
@freezed
class Usual with _$Usual {
  Usual({this.a});
  final int a;
}
```

This has multiple benefits:

- Simple classes don't need Freezed's "weird" syntax and can stay simple
- Unions can keep using the usual `factory` syntax

This also offers a way to use all constructor features, such as initializers
or `super()`:

```dart
class Base {
  Base(String value);
}

@freezed
class Usual extends Base with _$Usual {
  Usual({int? a}) a = a ?? 0, super('value');
  final int a;
}
```

### New: Inheritance and non-constant default values.

When using Freezed, a common problem has always been the lack of `extends` support and non-constant default values.

Besides through "Mixed mode" mentioned above, Freezed now offers a way for `factory` constructors to specify non-constant defaults and a `super()`, by
relying on the `MyClass._()` constructor:

It also has another benefit:  
Complex Unions now have a way to use Inheritance and non-constant default values,
by relying on a non-factory `MyClass._()` constructor.

For context:  
Before, when a Freezed class specified a property or method,
it was required to specify a `MyClass._()` constructor:

```dart
@freezed
class Example with _$Example {
  // Necessary for helloWorld() to work
  Example._();
  factory Example(String name) = _Example

  void helloWorld() => print('Hello $name');
}
```

However, that `Example._()` constructor was required to have no parameter.

Starting Freezed 3.0, this constructor can accept any parameter.
Freezed will them pass it values from other `factory` constructors, based on name.

In short, this enables extending any class:

```dart
class Subclass {
  Subclass.name(this.value);
  final int value;
}

@freezed
class MyFreezedClass extends Subclass with _$MyFreezedClass {
  // We can receive parameters in this constructor, which we can use with `super.field`
  MyFreezedClass._(super.value): super.name();

  factory MyFreezedClass(int value, /* other fields */) = _MyFreezedClass;
}
```

It also enables non-constant default values:

```dart
@freezed
sealed class Response<T> with _$Response<T> {
  // We give "time" parameters a non-constant default
  Response._({DateTime? time}) : time = time ?? DateTime.now();
  // Constructors may enable passing parameters to ._();
  factory Response.data(T value, {DateTime? time}) = ResponseData;
  // If ._ parameters are named and optional, factory constructors are not required to specify it
  factory Response.error(Object error) = ResponseError;

  @override
  final DateTime time;
}
```

### New: "Eject" union cases

Along with the mixed mode, it is also possible to eject
a "union" case, by having it point to a custom class.

Concretely, you can do:

```dart
@freezed
sealed class Result<T> with _$Result {
  Result._();
  // Data does not exist, so Freezed will generate it as usual
  factory Result.data(T data) = ResultData;
  // We wrote a ResultError class in the same library, so Freezed won't do anything
  factory Result.error(Object error) = ResultError;
}

// We manually wrote `ResultError`
class ResultError<T> extends Result<T> {
  ResultError(this.error): super._();
  final Object error;
}
```

This combines nicely with "Mixed mode" mentioned previously,
as extracted union cases can also be Freezed classes:

```dart
// Using freezed with a simple class:
@freezed
class ResultError<T> extends Result<T> {
  ResultError(this.error): super._();
  final Object error;
}

// Or using a factory:
@freezed
class ResultError<T> extends Result<T> {
  ResultError._(): super._();
  factory ResultError(Object error) = _ResultError;
}
```

This feature offers fine-grained control over every parts of your models.

**Note**:
Unfortunately, it is kind of required to "extend" the parent class (so here `extends Result<T>`). This is because Dart doesn't support `sealed mixin class`, so you can't do
`with Result<T>` instead.

### Other changes:

- **Breaking**: Removed `map/when` and variants. These have been discouraged since Dart got pattern matching.
- **Breaking**: Freezed classes should now either be `abstract`, `sealed`, or manually implements `_$MyClass`.
- When formatting is disabled (default), Freezed now generates `// dart format off`. This
  prevents having to exclude generated file from formatting check in the CI.
- It is now possible to have a private constructor for unions:
  ```dart
  @freezed
  sealed class Result<T> with _$Result {
    // It wasn't possible to write _data before, but now is.
    factory Result._data(T data) = ResultData;
    factory Result.error(Object error) = ResultError;
  }
  ```


---

Here's the migration guide:

## Migrate from v2 to v3

### Require keyword (`sealed` / `abstract`)

Classes using the factory constructor now require a keyword `sealed` / `abstract`.

```diff
@freezed
-class Person with _$Person {
+abstract class Person with _$Person {
  const factory Person({
    required String firstName,
    required String lastName,
    required int age,
  }) = _Person;

  factory Person.fromJson(Map<String, Object?> json)
      => _$PersonFromJson(json);
}
```

```diff
@freezed
-class Model with _$Model {
+sealed class Model with _$Model {
  factory Model.first(String a) = First;
  factory Model.second(int b, bool c) = Second;
}
```

### Pattern matching

Freezed no longer generates `.map`/`.when` extensions and their derivatives for freezed classes used for pattern matching. Instead, use Dart's built-in [pattern matching](https://dart.dev/language/patterns#matching) syntax.

```diff
final model = Model.first('42');

-final res = model.map(
-  first: (String a) => 'first $a',
-  second: (int b, bool c) => 'second $b $c',
-);
+final res = switch (model) {
+  First(:final a) => 'first $a',
+  Second(:final b, :final c) => 'second $b $c',
+};

```

---
