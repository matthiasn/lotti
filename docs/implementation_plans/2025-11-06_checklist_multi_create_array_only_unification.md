# Checklist Items — Array‑Only Multi‑Create, Single‑Item Tool Deprecation (2025‑11‑06)

## Summary

- Unify checklist creation to a single function: always create items in batches.
- Strictly require a JSON array of objects for the `items` argument; remove string fallback and any
  comma‑parsing. Each item is `{ title: string, isChecked?: boolean }`.
- Deprecate and remove the single‑item AI tool from exposure; for a single item, pass a one‑element
  array.
- Update prompts and tool schemas to reflect the array‑only contract and return a JSON array of
  created items for clarity.
- Add validation, tests, and instrumentation. Keep DB transaction/perf as a future follow‑up.

This supersedes and simplifies the prior hardening work documented in
`docs/implementation_plans/2025-10-28_checklist_item_parsing_hardening.md` by eliminating the
string‑parsing path entirely and removing the single‑item tool from the AI toolset.

## Goals

- Expose only one checklist creation tool to models (batch‑only).
- Tool input requires `items: array<object>` with each element
  `{ title: string, isChecked?: boolean }`.
  - Use the existing boolean name from the data model: `isChecked` (defaults to `false`).
  - No plain string fallback and no top‑level `oneOf`; always an array.
- Tool output returns `createdItems: array<{ id: string, title: string, isChecked: boolean }>`
  generated by the app (AI never assigns IDs).
- Update prompts to show and require a JSON array in examples and guidance.
- Validate inputs robustly (trim titles, drop empties, error if none remain) with helpful error
  messages that teach the array contract on failure.
- Enforce constraints: max 20 items per batch; max 400 characters per title after trim.
- Preserve input order exactly; no de‑duplication.
- Atomic batch semantics (all‑or‑nothing) via full pre‑validation before create.
- Analyzer zero warnings; full test coverage for handlers, schema, prompts, and integration flows.

## Non‑Goals

- Database performance optimization (transactions/bulk inserts) — follow‑up task.
- Provider/model gating. We will expose the single batch tool to all providers.
- Auto‑rescue of non‑array input (no implicit splitting or parsing of strings).

## Drivers (why now)

- Prior fix still allowed models to pick the single‑item tool and cram multiple items into a single
  string. That path could not be reliably parsed and produced malformed items.
- A single, well‑typed tool with no string fallback eliminates ambiguity and guards the flow.

## Design Overview

1) Tool schema (array‑only) and return value

- Keep the existing function name for continuity: `add_multiple_checklist_items`.
- Arguments (strict):
  - `items: array<{ title: string, isChecked?: boolean }>` — `minItems: 1`; `title` must be
    non‑empty after trim; `isChecked` defaults to `false`.
  - (Optional) `contextTaskId: string` — if the batch is associated with a specific task. Keep if
    already present today; otherwise omit.
- Return value:
  - `{ createdItems: array<{ id: string, title: string, isChecked: boolean }> }` — IDs are generated
    by the app; returned for reference and assertions.

2) Single‑item tool deprecation

- Stop exposing `add_checklist_item` to AI entirely.
- Internally, any existing code paths that rely on a single‑item helper should map to the batch code
  with a one‑element array to avoid code duplication.

3) Validation and error handling

- On handler entry:
  - Enforce `items` to be an array; reject other types with a descriptive error explaining the array
    contract and showing a one‑line example.
  - For each element:
    - Accept only objects with a `title` string (required) and optional `isChecked` boolean.
    - Ignore unknown keys.
    - Trim `title`; drop elements with empty titles after trimming.
    - Enforce `title.length <= 400` after trim; error if any exceeds.
  - If resulting list is empty → error with guidance.
  - Enforce batch size cap: max 20 items; error if exceeded.
  - Preserve input order and do not de‑duplicate items.
  - Perform full validation before any creation so the batch is atomic (all‑or‑nothing) without requiring DB transactions.
- Return a structured failure `FunctionCallResult` that triggers the normal retry guidance in the
  conversation layer.

4) Prompt updates (preconfigured + retry)

- Show only the batch tool and demonstrate usage with a JSON array of objects.
- Add explicit guidance lines, e.g.: “Always send checklist items as a JSON array of objects with
  `title`. If the transcript explicitly says an item is already done, set `isChecked: true`. Do not
  send comma‑separated strings.”
- Update retry messages to include the same contract in a single, concise sentence.
- Language: English only for now (no l10n in this pass).

5) Conversation/tool exposure

- Replace all checklist tool injection sites to expose only `add_multiple_checklist_items`.
- Remove any provider/model gating for multi‑item usage; batch tool is universal. Remove single‑item tool entirely (no shim).

6) Instrumentation (lightweight)

- Log (debug/dev): provider, model, count of `items`, handler duration, and success/failure. Use logging service.

## Code Touchpoints

- Tool schema and exposure
  - `lib/features/ai/functions/checklist_completion_functions.dart` — redefine
    `add_multiple_checklist_items` schema to array‑only objects (`{ title, isChecked? }`); remove
    `add_checklist_item` from toolset.
  - `lib/features/ai/repository/unified_ai_inference_repository.dart` — in all tool injection
    points (~lines ≈676, ≈696, ≈1569), expose only the batch tool.

- Handlers
  - `lib/features/ai/functions/lotti_batch_checklist_handler.dart` — strict array validation of
    `{ title, isChecked? }`, trimming, defaults; returns `createdItems` array. Becomes the only AI
    entry for creation.
  - `lib/features/ai/functions/lotti_checklist_handler.dart` — deprecate. If still used by app code,
    re‑route to the batch handler with a 1‑element array; otherwise remove.

- Conversation/prompting
  - `lib/features/ai/functions/lotti_conversation_processor.dart` — unify retry guidance, ensure
    error surfaces the array contract succinctly.
  - `lib/features/ai/util/preconfigured_prompts.dart` — remove single‑item examples; add array‑only
    examples.

- Tests
  - `test/features/ai/functions/lotti_batch_checklist_handler_test.dart` — array‑only objects happy
    paths; invalid element shapes; trimming/empty filtering; `isChecked` default behavior;
    over‑limit; return payload assertions (includes `isChecked`).
  - `test/features/ai/functions/checklist_completion_functions_test.dart` — assert schema is array
    of objects with `{ title, isChecked? }`; no `oneOf`; no single‑item tool exposed.
  - `test/features/ai/repository/unified_ai_inference_repository_tools_test.dart` — tool exposure
    contains only the batch tool across providers/models.
  - `test/features/ai/conversation/retry_guidance_test.dart` — failure messaging includes concise
    array contract, `isChecked` guidance, and example.

## Implementation Plan

A) Schema + exposure

- Update `checklist_completion_functions.dart` to define `add_multiple_checklist_items`:
  - `items: array<{ title: string, isChecked?: boolean }>` with `minItems: 1`; no string fallback.
  - Response: `{ createdItems: array<{ id: string, title: string, isChecked: boolean }> }`.
- Remove `add_checklist_item` from any `getTools()` collections and from all injection sites in
  `unified_ai_inference_repository.dart`.

B) Handler unification

- In `lotti_batch_checklist_handler.dart`, add strict validation and trimming; enforce caps; create items; return the `createdItems` array. Preserve input order.
- Remove single‑item handler from the AI toolset and delete any shim; perform code search and update references accordingly.

C) Prompt and retry messaging

- Update preconfigured prompts to show only the array‑based tool. Include one short code example:
  `{ "items": [{"title": "Pick up milk"}, {"title": "Email Alex"}, {"title": "Write tests", "isChecked": true}] }`.
- Update retry prompts in conversation processor to include: “Use a JSON array of objects with
  `title` (and `isChecked` if already done); do not send a comma‑separated string.”

D) Instrumentation

- Add lightweight logs (dev builds) for: provider, model, `items.length`, creation duration,
  success/failure.
- Optionally add a debug counter surfaced in dev tools for manual validation.

E) Tests (iterate per repo guidelines)

- Write targeted unit tests for schema exposure and handler validation.
- Add integration tests ensuring only the batch tool is exposed across providers and that a single
  item is created via a one‑element array.
- Tests in any edited or created test file must pass before moving to the next.
- Use mcp to run tests, don't use the compact reporter.

### Test Stabilization Update (2025‑11‑06)

- Conversation tests previously relied on brittle streaming mocks (chunk assembly and id/index
  stitching) which caused flakiness and false negatives. These have been replaced with a
  deterministic test helper that stubs `ConversationRepository.sendMessage` and directly invokes the
  provided strategy (`LottiChecklistStrategy`) with predefined `ChatCompletionMessageToolCall`s.
  This preserves the exact strategy and handler semantics while removing stream brittleness.
- New/updated tests:
  - `test/features/ai/functions/lotti_conversation_processor_via_repo_test.dart` — five scenarios
    (single item via batch, multi‑item batch, GPT‑OSS batch, language detection + create, non‑GPT
    batch) now use the deterministic `sendMessage` stub and pass reliably.
  - Removed the legacy skipped cases from
    `test/features/ai/functions/lotti_conversation_processor_test.dart` that depended on the
    streaming path.
- Handler tests (`lotti_batch_checklist_handler_test.dart`) assert callback/task refresh behavior
  and return payload, with analyzer cleanups applied.

F) Housekeeping

- Run formatter and analyzer until zero warnings.
- Update CHANGELOG: “AI checklist creation unified to array‑only batch tool; single‑item tool
  removed from AI toolset; parsing issues fixed.”
- Update any relevant feature README to document the array‑only contract.

## Rollout & Migration

- Rollout: straight switch (low risk) because we remove ambiguity; the tool schema itself enforces the correct input type.
- Backward compatibility: not required. Single‑item tool removed from exposure; no shim.
- Fallback strategy: not required.

## Risks & Mitigations

- Model compliance: Some models might try to send a plain string. Mitigation: strict validation + a
  clear, concise error that shows the correct JSON array form; conversation retry will recover.
- Very large batches: May cause latency or UI feedback delays. Mitigation: cap at 20 and communicate limit in error.
- Unintended external dependency on single‑item code: Search and deprecate, forward to batch handler
  until fully removed.

## Acceptance Criteria

- Only `add_multiple_checklist_items` is exposed to models across all providers.
- Tool schema for `add_multiple_checklist_items` requires `items: array<{ title, isChecked? }>` (no
  top‑level `oneOf`).
- Handler rejects non‑array inputs and invalid element shapes with a specific error that instructs
  the JSON array contract.
- Valid arrays (including size 1) create items and return `{ createdItems: [...] }` with correct IDs, titles (<= 400 chars), and `isChecked` values.
- Batch respects input order; duplicates are allowed and preserved.
- Prompts and retry guidance show only the array‑based usage.
- Analyzer zero warnings; all new and existing tests pass.
- Telemetry/logs show batch creation usage with expected item counts and reasonable latency.

## Decisions (confirmed)

- Max items per batch: 20
- Title length cap: 400 (after trim)
- Preserve input order; no de‑dup
- Atomic batch via full pre‑validation
- Ignore unknown keys
- Remove single‑item tool entirely (no shim)
- English‑only prompts for now

## Related

- Prior plan: `docs/implementation_plans/2025-10-28_checklist_item_parsing_hardening.md`
- Screenshot/regression notes captured in that doc’s “2025‑11‑02 Investigation”.

## Status

- Proposal — ready for implementation
