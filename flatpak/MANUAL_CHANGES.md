# Manual Changes Required for Successful Flatpak Build

This document outlines the manual changes that were made to achieve a successful offline Flatpak build for Lotti.

## Issues Encountered and Solutions

### 1. Cargokit Scripts Not Using Offline Mode

**Problem:** The cargokit-based Rust plugins (flutter_vodozemac, super_native_extensions, irondash_engine_context) were trying to fetch dependencies from the network during build, even though we had `--offline` flags for Flutter.

**Solution Applied:**
- Modified the glob pattern in the prepare script to find cargokit scripts at both one and two levels deep:
  - Changed from `*/*/cargokit/run_build_tool.sh`
  - To also include `*/cargokit/run_build_tool.sh`
- This ensures the scripts are properly patched to add `--offline` flag to `pub get` commands

### 2. Cargo Vendor Configuration Not Being Used

**Problem:** Even with vendored Cargo dependencies, the cargokit build process wasn't using them because it didn't know about the vendor directory.

**Solution Applied:**
- Added a new build command to create a Cargo config file that points to the vendored sources:
```bash
mkdir -p "$CARGO_HOME" && cat > "$CARGO_HOME/config" <<'CARGO_CFG'
[source.vendored-sources]
directory = "/run/build/lotti/cargo/vendor"

[source.crates-io]
replace-with = "vendored-sources"

[source."https://github.com/knopp/mime_guess"]
git = "https://github.com/knopp/mime_guess"
replace-with = "vendored-sources"
branch = "super_native_extensions"
CARGO_CFG
```

### 3. Cargo Dependency Version Mismatches

**Problem:** The cargo-sources.json generated by flatpak-flutter had incorrect dependency versions, causing errors like:
`error: failed to select a version for the requirement 'anyhow = "^1.0.69"' (locked to 1.0.97)`

**Manual Fix Applied:**
- Regenerated cargo-sources.json using the actual Cargo.lock files from the plugins:
```bash
python3 flatpak-flutter/cargo_generator/cargo_generator.py \
  flathub-build/output/.flatpak-builder/build/lotti-1/.pub-cache/hosted/pub.dev/irondash_engine_context-0.5.5/android/rust/Cargo.lock,\
  flathub-build/output/.flatpak-builder/build/lotti-1/.pub-cache/hosted/pub.dev/super_native_extensions-0.9.1/rust/Cargo.lock,\
  flathub-build/output/.flatpak-builder/build/lotti-1/.pub-cache/hosted/pub.dev/flutter_vodozemac-0.2.2/rust/Cargo.lock \
  -o flathub-build/output/cargo-sources.json
```
- This generated the correct versions needed by the actual plugins

## Files Modified After Generation

1. **cargo-sources.json** - Replaced with version regenerated from actual Cargo.lock files
2. **com.matthiasn.lotti.yml** - The manifest was automatically updated by the prepare script with:
   - Cargo config setup command
   - Fixed cargokit patching command

## Recommended Script Improvements

To make these changes permanent, the prepare_flathub_submission.sh script should be updated to:

1. **Fix Cargo.lock discovery pattern** to find files in various locations:
   - android/rust/Cargo.lock
   - rust/Cargo.lock
   - linux/rust/Cargo.lock
   - etc.

2. **Ensure the cargo config command is always added** to set up vendor directory usage

3. **Fix the cargokit script glob pattern** to check both `*/cargokit/` and `*/*/cargokit/` paths

## Current Status

The automated script has been updated with all the fixes:
1. ✅ Cargo.lock discovery now searches all possible locations (android/rust, rust/, etc.)
2. ✅ Cargo config command is automatically added to the manifest
3. ✅ Cargokit script glob pattern fixed to check both depths

However, there's still an issue with cargo-sources.json generation:
- The cargo-sources.json is generated from the initial flatpak-flutter run
- But the actual Cargo.lock files in the build directory may have different dependency versions
- This causes version mismatch errors like: `error: failed to select a version for the requirement 'anyhow = "^1.0.69"' (locked to 1.0.97)`

## Remaining Issue

The cargo-sources.json generation happens too early in the process. It needs to:
1. Run after the first build populates the .pub-cache with actual plugin code
2. Use the Cargo.lock files from the actual plugins being built
3. Include all required versions of dependencies

## Workaround

After running prepare_flathub_submission.sh, if the build fails with cargo version errors:
1. Find the Cargo.lock files in the build directory
2. Regenerate cargo-sources.json using those files
3. Replace the cargo-sources.json in the output directory

## Next Steps

The prepare_flathub_submission.sh script has been updated with all the structural fixes. The cargo-sources.json version issue may require a two-phase build process or manual regeneration for now.