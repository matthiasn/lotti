# Manual Changes Required for Successful Flatpak Build

This document outlines the manual changes that were made to achieve a successful offline Flatpak build for Lotti.

## Issues Encountered and Solutions

### 1. Cargokit Scripts Not Using Offline Mode

**Problem:** The cargokit-based Rust plugins (flutter_vodozemac, super_native_extensions, irondash_engine_context) were trying to fetch dependencies from the network during build, even though we had `--offline` flags for Flutter.

**Solution Applied:**
- Modified the glob pattern in the prepare script to find cargokit scripts at both one and two levels deep:
  - Changed from `*/*/cargokit/run_build_tool.sh`
  - To also include `*/cargokit/run_build_tool.sh`
- This ensures the scripts are properly patched to add `--offline` flag to `pub get` commands

### 2. Cargo Vendor Configuration Not Being Used

**Problem:** Even with vendored Cargo dependencies, the cargokit build process wasn't using them because it didn't know about the vendor directory.

**Solution Applied:**
- Added a new build command to create a Cargo config file that points to the vendored sources:
```bash
mkdir -p "$CARGO_HOME" && cat > "$CARGO_HOME/config" <<'CARGO_CFG'
[source.vendored-sources]
directory = "/run/build/lotti/cargo/vendor"

[source.crates-io]
replace-with = "vendored-sources"

[source."https://github.com/knopp/mime_guess"]
git = "https://github.com/knopp/mime_guess"
replace-with = "vendored-sources"
branch = "super_native_extensions"
CARGO_CFG
```

### 3. Cargo Dependency Version Mismatches

**Problem:** The cargo-sources.json generated by flatpak-flutter had incorrect dependency versions, causing errors like:
`error: failed to select a version for the requirement 'anyhow = "^1.0.69"' (locked to 1.0.97)`

**Manual Fix Applied:**
- Regenerated cargo-sources.json using the actual Cargo.lock files from the plugins:
```bash
python3 flatpak-flutter/cargo_generator/cargo_generator.py \
  flathub-build/output/.flatpak-builder/build/lotti-1/.pub-cache/hosted/pub.dev/irondash_engine_context-0.5.5/android/rust/Cargo.lock,\
  flathub-build/output/.flatpak-builder/build/lotti-1/.pub-cache/hosted/pub.dev/super_native_extensions-0.9.1/rust/Cargo.lock,\
  flathub-build/output/.flatpak-builder/build/lotti-1/.pub-cache/hosted/pub.dev/flutter_vodozemac-0.2.2/rust/Cargo.lock \
  -o flathub-build/output/cargo-sources.json
```
- This generated the correct versions needed by the actual plugins

## Files Modified After Generation

1. **cargo-sources.json** - Replaced with version regenerated from actual Cargo.lock files
2. **com.matthiasn.lotti.yml** - The manifest was automatically updated by the prepare script with:
   - Cargo config setup command
   - Fixed cargokit patching command

## Recommended Script Improvements

To make these changes permanent, the prepare_flathub_submission.sh script should be updated to:

1. **Fix Cargo.lock discovery pattern** to find files in various locations:
   - android/rust/Cargo.lock
   - rust/Cargo.lock
   - linux/rust/Cargo.lock
   - etc.

2. **Ensure the cargo config command is always added** to set up vendor directory usage

3. **Fix the cargokit script glob pattern** to check both `*/cargokit/` and `*/*/cargokit/` paths

## Verification

After these changes, the build completes successfully with:
- No network access attempts
- All Rust plugins building correctly
- Application successfully installed to /app/lotti

The build can be verified with:
```bash
cd flathub-build/output
flatpak-builder --force-clean --disable-updates build-dir com.matthiasn.lotti.yml
```

## Next Steps

These manual fixes should be incorporated into the prepare_flathub_submission.sh script to ensure reproducible builds without manual intervention.