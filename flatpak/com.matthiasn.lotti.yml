app-id: com.matthiasn.lotti
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm20
  - org.freedesktop.Sdk.Extension.rust-stable
add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    version: '24.08'
    add-ld-path: .
command: /app/lotti-wrapper
finish-args:
  - --share=network
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --device=dri
  # Secure filesystem permissions following principle of least privilege
  - --filesystem=xdg-documents/Lotti:create # Only create Lotti folder in documents
  - --filesystem=xdg-pictures:ro # Read-only access to pictures for import
  - --filesystem=xdg-download/Lotti:create # Only create Lotti folder in downloads
  # App data is automatically available in ~/.var/app/com.matthiasn.lotti/
  # Portal access for sandboxed functionality
  - --talk-name=org.freedesktop.portal.Desktop
  - --talk-name=org.freedesktop.portal.Screenshot
  # Note: No microphone portal exists yet - audio access via --socket=pulseaudio above
# Build options moved to Flutter module
modules:
  - name: python3-jinja2
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --no-index --find-links="file://${PWD}" --prefix=${FLATPAK_DEST} "MarkupSafe" "jinja2" --no-build-isolation
    sources:
      - type: file
        url: https://files.pythonhosted.org/packages/31/80/3a54838c3fb461f6fec263ebf3a3a41771bd05190238de3486aae8540c36/jinja2-3.1.4-py3-none-any.whl
        sha256: bc5dd2abb727a5319567b7a813e6a2e7318c39f4f487cfe6c89c6f9c7d25197d
      - type: file
        url: https://files.pythonhosted.org/packages/87/5b/aae44c6655f3801e81aa3eef09dbbf012431987ba564d7231722f68df02d/MarkupSafe-2.1.5.tar.gz
        sha256: d283d37a890ba4c1ae73ffadf8046435c76e7bc2247bbb63c00bd1a709c6544b
  - name: libplacebo
    buildsystem: meson
    config-opts:
      - -Dglslang=disabled
      - -Dshaderc=disabled
      - -Dvulkan=disabled
      - -Dd3d11=disabled
      - -Ddemos=false
      - -Dopengl=disabled
      - -Dtests=false
    sources:
      - type: archive
        url: https://github.com/haasn/libplacebo/archive/refs/tags/v6.338.2.tar.gz
        sha256: 2f1e624e09d72a8c9db70f910f7560e764a1c126dae42acc5b3bcef836a7aec6
  - name: libass
    buildsystem: autotools
    config-opts:
      - --disable-static
    sources:
      - type: archive
        url: https://github.com/libass/libass/releases/download/0.17.1/libass-0.17.1.tar.xz
        sha256: f0da0bbfba476c16ae3e1cfd862256d30915911f7abaa1b16ce62ee653192784
    cleanup:
      - /include
      - /lib/pkgconfig
  - name: libmpv
    buildsystem: meson
    build-options:
      env:
        PKG_CONFIG_PATH: /app/lib64/pkgconfig:/app/lib/pkgconfig
    config-opts:
      - -Dlibmpv=true
      - -Dlua=disabled
      - -Ddebug=false
      - -Dbuild-date=false
      - -Dmanpage-build=disabled
      - -Dsdl2=disabled
      - -Dvulkan=disabled
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/v0.38.0.tar.gz
        sha256: 86d9ef40b6058732f67b46d0bbda24a074fae860b3eaae05bab3145041303066
  - name: libsecret
    buildsystem: meson
    config-opts:
      - -Dmanpage=false
      - -Dvapi=false
      - -Dgcrypt=false
      - -Dgtk_doc=false
      - -Dintrospection=false
    sources:
      - type: archive
        url: https://gitlab.gnome.org/GNOME/libsecret/-/archive/0.20.5/libsecret-0.20.5.tar.gz
        sha256: b33b9542222ea8866f6ff2d31c0ad373877c2277db546ca00cc7fdda9cbab1c3
  - name: libkeybinder
    buildsystem: autotools
    sources:
      - type: archive
        url: https://github.com/kupferlauncher/keybinder/releases/download/keybinder-3.0-v0.3.2/keybinder-3.0-0.3.2.tar.gz
        sha256: e6e3de4e1f3b201814a956ab8f16dfc8a262db1937ff1eee4d855365398c6020
  - name: flutter-sdk
    buildsystem: simple
    build-options:
      build-args:
        - --share=network
    build-commands:
      # Clone Flutter SDK from Git (pinned to 3.35.4)
      - git clone https://github.com/flutter/flutter.git -b 3.35.4 --depth 1 /app/flutter
      # Precache Flutter artifacts to ensure all required binaries are downloaded
      - export PATH=/app/flutter/bin:$PATH
      - /app/flutter/bin/flutter --version
      - /app/flutter/bin/flutter precache --linux
    sources: []
  - name: lotti
    buildsystem: simple
    build-options:
      build-args:
        - --share=network
      append-path: /usr/lib/sdk/llvm20/bin
      prepend-ld-library-path: /usr/lib/sdk/llvm20/lib
      env:
        PUB_CACHE: /run/build/lotti/.pub-cache
        FLUTTER_ROOT: /run/build/lotti/flutter_sdk
        PATH: /run/build/lotti/flutter_sdk/bin:/run/build/lotti/.cargo/bin:/usr/lib/sdk/llvm20/bin:/usr/bin:/bin
        CARGO_HOME: /run/build/lotti/.cargo
        RUSTUP_HOME: /run/build/lotti/.cargo
    build-commands:
      # Copy Flutter SDK to writable location
      - echo "Setting up Flutter SDK..."
      - cp -r /app/flutter /run/build/lotti/flutter_sdk
      - chmod -R u+w /run/build/lotti/flutter_sdk
      # Install Rust using rustup
      - echo "Installing Rust..."
      - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable --profile minimal
      - export PATH="$HOME/.cargo/bin:$PATH"
      - rustc --version
      - cargo --version
      # Configure Flutter
      - echo "Building Lotti from source..."
      - /run/build/lotti/flutter_sdk/bin/flutter config --no-analytics --no-cli-animations
      # Get dependencies and build
      - /run/build/lotti/flutter_sdk/bin/flutter pub get
      - /run/build/lotti/flutter_sdk/bin/flutter build linux --release --verbose
      # Install the built app
      - echo "Installing Flutter bundle..."
      - cp -r build/linux/*/release/bundle/* /app/
      # Remove 1024x1024 icons to comply with Flatpak's maximum icon size limit
      - find /app -name "*1024*" -type f -delete
      - chmod +x /app/lotti
      # Create directories
      - mkdir -p /app/lib/ffmpeg
      # Create wrapper script
      - |
        cat > /app/lotti-wrapper << 'EOF'
        #!/bin/bash
        export LD_LIBRARY_PATH=/app/lib:/app/lib64:$LD_LIBRARY_PATH

        # Set GDK_BACKEND conditionally
        if [ -z "$WAYLAND_DISPLAY" ] && [ "$XDG_SESSION_TYPE" != "wayland" ]; then
          export GDK_BACKEND=x11
        fi

        cd /app
        exec ./lotti "$@"
        EOF
      - chmod +x /app/lotti-wrapper
    sources:
      - type: git
        url: https://github.com/matthiasn/lotti
        commit: 07e53c799b6aa43ad361902bad86a27ded4bf5d4
      # Or use a tarball:
      # - type: archive
      #   url: https://github.com/matthiasn/lotti/archive/refs/tags/v0.9.645.tar.gz
      #   sha256: CHECKSUM_HERE
  - name: flutter-common
    buildsystem: simple
    build-commands:
      - install -D com.matthiasn.lotti.desktop /app/share/applications/com.matthiasn.lotti.desktop
      - install -D com.matthiasn.lotti.metainfo.xml /app/share/metainfo/com.matthiasn.lotti.metainfo.xml
      # Install icons with proper sizes (max 512x512)
      - install -D app_icon_512.png /app/share/icons/hicolor/512x512/apps/com.matthiasn.lotti.png
      - install -D app_icon_256.png /app/share/icons/hicolor/256x256/apps/com.matthiasn.lotti.png
      - install -D app_icon_128.png /app/share/icons/hicolor/128x128/apps/com.matthiasn.lotti.png
      - install -D app_icon_64.png /app/share/icons/hicolor/64x64/apps/com.matthiasn.lotti.png
      - install -D app_icon_48.png /app/share/icons/hicolor/48x48/apps/com.matthiasn.lotti.png
      - install -D app_icon_32.png /app/share/icons/hicolor/32x32/apps/com.matthiasn.lotti.png
      - install -D app_icon_16.png /app/share/icons/hicolor/16x16/apps/com.matthiasn.lotti.png
    sources:
      - type: file
        path: com.matthiasn.lotti.desktop
      - type: file
        path: com.matthiasn.lotti.metainfo.xml  # Use static version, not generated
      - type: file
        path: app_icon_512.png
      - type: file
        path: app_icon_256.png
      - type: file
        path: app_icon_128.png
      - type: file
        path: app_icon_64.png
      - type: file
        path: app_icon_48.png
      - type: file
        path: app_icon_32.png
      - type: file
        path: app_icon_16.png
