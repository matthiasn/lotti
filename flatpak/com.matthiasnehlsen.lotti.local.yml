app-id: com.matthiasnehlsen.lotti
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    version: '24.08'
    add-ld-path: .
    
build-options:
  env:
    LD_LIBRARY_PATH: /app/lib:/app/lib64:/app/lib/ffmpeg
command: /app/lotti
finish-args:
  - --env=LD_LIBRARY_PATH=/app/lib:/app/lib64:/app/lib/ffmpeg
  - --share=network
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --device=dri
  - --filesystem=xdg-documents/Lotti:create
  - --filesystem=xdg-pictures:ro
  - --filesystem=xdg-download/Lotti:create
  # DBus access for system services
  - --system-talk-name=org.freedesktop.NetworkManager
  # Secret service access for keyring
  - --talk-name=org.freedesktop.secrets
  
modules:
  - name: libsecret
    buildsystem: meson
    config-opts:
      - -Dmanpage=false
      - -Dvapi=false
      - -Dgcrypt=false
      - -Dgtk_doc=false
      - -Dintrospection=false
    sources:
      - type: archive
        url: https://gitlab.gnome.org/GNOME/libsecret/-/archive/0.20.5/libsecret-0.20.5.tar.gz
        sha256: b33b9542222ea8866f6ff2d31c0ad373877c2277db546ca00cc7fdda9cbab1c3

  - name: libkeybinder
    buildsystem: autotools
    sources:
      - type: archive
        url: https://github.com/kupferlauncher/keybinder/releases/download/keybinder-3.0-v0.3.2/keybinder-3.0-0.3.2.tar.gz
        sha256: e6e3de4e1f3b201814a956ab8f16dfc8a262db1937ff1eee4d855365398c6020

  - name: lotti
    buildsystem: simple
    build-commands:
      # Create proper directory structure  
      - mkdir -p /app/lib
      - mkdir -p /app/lib/ffmpeg
      - mkdir -p /app/share
      
      # Copy entire Flutter bundle to /app (Flutter expects this structure)
      - cp -r . /app/
      
      # Remove 1024x1024 icons to comply with Flatpak's maximum icon size limit of 512x512
      - find /app -name "*1024*" -type f -delete
      
      # Ensure executable permissions
      - chmod +x /app/lotti
      
    sources:
      - type: dir
        path: flutter-bundle