app-id: com.matthiasnehlsen.lotti
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
modules:
  - name: desktop-drop-plugin
    buildsystem: simple
    build-commands:
      - install -D libdesktop_drop_plugin.so /app/lib/
    sources:
      - type: file
        path: ../lib/libdesktop_drop_plugin.so
  - name: flutter-dependencies
    buildsystem: simple
    build-commands:
      - install -D libflutter_linux_gtk.so /app/lib/ 2>/dev/null || echo "libflutter_linux_gtk.so not found"
      - install -D libgtk-3.so.0 /app/lib/ 2>/dev/null || echo "libgtk-3.so.0 not found"
      - install -D libgdk-3.so.0 /app/lib/ 2>/dev/null || echo "libgdk-3.so.0 not found"
      - install -D libcairo.so.2 /app/lib/ 2>/dev/null || echo "libcairo.so.2 not found"
      - install -D libpango-1.0.so.0 /app/lib/ 2>/dev/null || echo "libpango-1.0.so.0 not found"
      - install -D libpangocairo-1.0.so.0 /app/lib/ 2>/dev/null || echo "libpangocairo-1.0.so.0 not found"
      - install -D libatk-1.0.so.0 /app/lib/ 2>/dev/null || echo "libatk-1.0.so.0 not found"
      - install -D libgdk_pixbuf-2.0.so.0 /app/lib/ 2>/dev/null || echo "libgdk_pixbuf-2.0.so.0 not found"
      - install -D libgio-2.0.so.0 /app/lib/ 2>/dev/null || echo "libgio-2.0.so.0 not found"
      - install -D libgobject-2.0.so.0 /app/lib/ 2>/dev/null || echo "libgobject-2.0.so.0 not found"
      - install -D libglib-2.0.so.0 /app/lib/ 2>/dev/null || echo "libglib-2.0.so.0 not found"
    sources:
      - type: file
        path: ../lib/libflutter_linux_gtk.so
      - type: file
        path: ../lib/libgtk-3.so.0
      - type: file
        path: ../lib/libgdk-3.so.0
      - type: file
        path: ../lib/libcairo.so.2
      - type: file
        path: ../lib/libpango-1.0.so.0
      - type: file
        path: ../lib/libpangocairo-1.0.so.0
      - type: file
        path: ../lib/libatk-1.0.so.0
      - type: file
        path: ../lib/libgdk_pixbuf-2.0.so.0
      - type: file
        path: ../lib/libgio-2.0.so.0
      - type: file
        path: ../lib/libgobject-2.0.so.0
      - type: file
        path: ../lib/libglib-2.0.so.0
command: /app/lotti-wrapper
finish-args:
  - --share=network
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  # Secure filesystem permissions following principle of least privilege
  - --filesystem=xdg-documents:rw    # For importing/exporting journal data
  - --filesystem=xdg-pictures:ro     # For importing images into journal entries
  - --filesystem=xdg-download:rw     # For downloading/saving exports
  # App data is automatically available in ~/.var/app/com.matthiasnehlsen.lotti/
  - --device=dri
  # Add required libraries
  - --env=LD_LIBRARY_PATH=/app/lib
  # Removed --socket=gpg-agent (not needed unless app specifically uses GPG)
modules:
  - name: lotti
    buildsystem: simple
    build-options:
      strip: true
      no-debuginfo: true
    build-commands:
      - echo "Installing pre-built Flutter app..."
      - ls -la
      - cp lotti /app/
      - echo "Installing shared libraries..."
      - mkdir -p /app/lib
      - cp -r lib/* /app/lib/ 2>/dev/null || echo "No lib files to copy"
      - echo "Creating wrapper script..."
      - echo '#!/bin/bash' > /app/lotti-wrapper
      - echo 'export LD_LIBRARY_PATH=/app/lib:$LD_LIBRARY_PATH' >> /app/lotti-wrapper
      - echo 'echo "Wrapper script running with LD_LIBRARY_PATH=$LD_LIBRARY_PATH"' >> /app/lotti-wrapper
      - echo 'ls -la /app/lib/ 2>/dev/null || echo "No lib directory"' >> /app/lotti-wrapper
      - echo 'exec /app/lotti "$@"' >> /app/lotti-wrapper
      - chmod +x /app/lotti-wrapper
      - echo "Wrapper script created:"
      - cat /app/lotti-wrapper
    sources:
      - type: git
        url: {{LOTTI_REPO_URL}}
        branch: fix/flatpak-kb-fix-v2
      - type: file
        path: ../lotti
      - type: dir
        path: ../lib
    modules:
      - name: flutter-common
        buildsystem: simple
        build-commands:
          - install -D com.matthiasnehlsen.lotti.desktop /app/share/applications/com.matthiasnehlsen.lotti.desktop
          # Skip metainfo and icon for now to get basic functionality working
          # - install -D com.matthiasnehlsen.lotti.generated.metainfo.xml /app/share/metainfo/com.matthiasnehlsen.lotti.metainfo.xml
          # - install -D app_icon_1024.png /app/share/icons/hicolor/symbolic/apps/com.matthiasnehlsen.lotti.png
        sources:
          - type: file
            path: com.matthiasnehlsen.lotti.desktop
          # Skip metainfo and icon sources for now
          # - type: file
          #   path: com.matthiasnehlsen.lotti.generated.metainfo.xml
          # - type: file
          #   path: app_icon_1024.png 