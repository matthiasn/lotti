app-id: com.matthiasnehlsen.lotti
runtime: org.gnome.Platform
runtime-version: '45'
sdk: org.gnome.Sdk
modules:
  - name: setup
    buildsystem: simple
    build-commands:
      - mkdir -p /app/lib
      - mkdir -p /app/share/applications
      - mkdir -p /app/share/metainfo
      - mkdir -p /app/share/icons/hicolor/apps
  - name: desktop-drop-plugin
    buildsystem: simple
    build-commands:
      - install -D libdesktop_drop_plugin.so /app/lib/
    sources:
      - type: file
        path: ../lib/libdesktop_drop_plugin.so

  - name: lotti
    buildsystem: simple
    build-options:
      strip: true
      no-debuginfo: true
    build-commands:
      - echo "Installing pre-built Flutter app..."
      - ls -la
      - cp lotti /app/
      - echo "Installing shared libraries..."
      - mkdir -p /app/lib
      - cp -r lib/* /app/lib/ 2>/dev/null || echo "No lib files to copy"
      - echo "Searching for .so files in project root:"
      - find . -name "*.so" -type f -exec cp {} /app/lib/ \; 2>/dev/null || echo "No .so files found"
      - echo "Creating dummy libkeybinder-3.0.so.0..."
      - echo "#include <glib.h>" > dummy_keybinder.c
      - echo "void g_once_init_enter_pointer(void* location) {}" >> dummy_keybinder.c
      - echo "void g_once_init_leave(void* location, gpointer result) {}" >> dummy_keybinder.c
      - echo "void keybinder_init(void) {}" >> dummy_keybinder.c
      - echo "void keybinder_bind(const char* keystring, KeybinderHandler handler, void* user_data) {}" >> dummy_keybinder.c
      - echo "void keybinder_unbind(const char* keystring, KeybinderHandler handler) {}" >> dummy_keybinder.c
      - echo "typedef void (*KeybinderHandler)(const char* keystring, void* user_data);" >> dummy_keybinder.c
      - echo "int main() { return 0; }" >> dummy_keybinder.c
      - gcc -shared -o /app/lib/libkeybinder-3.0.so.0 dummy_keybinder.c -lglib-2.0 2>/dev/null || echo "Failed to create dummy library with glib"
      - gcc -shared -o /app/lib/libkeybinder-3.0.so.0 dummy_keybinder.c 2>/dev/null || echo "Failed to create dummy library without glib"
      - echo "Checking if dummy library was created:"
      - ls -la /app/lib/libkeybinder-3.0.so.0 2>/dev/null || echo "Dummy library not found"
      - rm -f dummy_keybinder.c
      - echo "Contents of /app/lib/ after copying:"
      - ls -la /app/lib/
      - echo "Creating wrapper script..."
      - echo '#!/bin/bash' > /app/lotti-wrapper
      - echo 'export LD_LIBRARY_PATH=/app/lib:$LD_LIBRARY_PATH' >> /app/lotti-wrapper
      - echo 'echo "Wrapper script running with LD_LIBRARY_PATH=$LD_LIBRARY_PATH"' >> /app/lotti-wrapper
      - echo 'ls -la /app/lib/ 2>/dev/null || echo "No lib directory"' >> /app/lotti-wrapper
      - echo 'exec /app/lotti "$@"' >> /app/lotti-wrapper
      - chmod +x /app/lotti-wrapper
      - echo "Wrapper script created:"
      - cat /app/lotti-wrapper
    sources:
      - type: git
        url: {{LOTTI_REPO_URL}}
        branch: fix/flatpak-kb-fix-v2
      - type: file
        path: ../lotti
      - type: dir
        path: ../lib
  - name: flutter-common
    buildsystem: simple
    build-commands:
      - install -D com.matthiasnehlsen.lotti.desktop /app/share/applications/com.matthiasnehlsen.lotti.desktop
    sources:
      - type: file
        path: com.matthiasnehlsen.lotti.desktop
command: /app/lotti-wrapper
finish-args:
  - --share=network
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --filesystem=xdg-documents:rw
  - --filesystem=xdg-pictures:ro
  - --filesystem=xdg-download:rw
  - --device=dri
  - --env=LD_LIBRARY_PATH=/app/lib
  - --socket=x11
  - --socket=wayland 