app-id: com.matthiasnehlsen.lotti
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    version: '24.08'
    add-ld-path: .
command: /app/lotti-wrapper
finish-args:
  - --share=network
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --device=dri
  # Secure filesystem permissions following principle of least privilege
  - --filesystem=xdg-documents/Lotti:create    # Only create Lotti folder in documents
  - --filesystem=xdg-pictures:ro               # Read-only access to pictures for import
  - --filesystem=xdg-download/Lotti:create     # Only create Lotti folder in downloads
  # App data is automatically available in ~/.var/app/com.matthiasnehlsen.lotti/
  # Portal access for sandboxed functionality
  - --talk-name=org.freedesktop.portal.Desktop
  - --talk-name=org.freedesktop.portal.Screenshot
  - --talk-name=org.freedesktop.portal.Device
  
modules:
  - name: libsecret
    buildsystem: meson
    config-opts:
      - -Dmanpage=false
      - -Dvapi=false
      - -Dgcrypt=false
      - -Dgtk_doc=false
      - -Dintrospection=false
    sources:
      - type: archive
        url: https://gitlab.gnome.org/GNOME/libsecret/-/archive/0.20.5/libsecret-0.20.5.tar.gz
        sha256: b33b9542222ea8866f6ff2d31c0ad373877c2277db546ca00cc7fdda9cbab1c3

  # Desktop drop plugin - built from source
  # This is a Flutter plugin that enables drag-and-drop functionality on Linux desktop
  # Built from source for better security and reproducibility
  # Dependencies: GTK (via PkgConfig::GTK) and Flutter (available in build environment)
  - name: desktop-drop-plugin
    buildsystem: cmake
    build-options:
      strip: true
      no-debuginfo: true
    build-commands:
      - mkdir -p build
      - cd build
      - cmake .. -DCMAKE_BUILD_TYPE=Release
      - make -j$(nproc)
      - mkdir -p /app/lib
      - install -D libdesktop_drop_plugin.so /app/lib/
    sources:
      - type: archive
        url: https://pub.dev/packages/desktop_drop/versions/0.6.1.tar.gz
        sha256: 927511f590ce01ee90d0d80f79bc71b9c919d8522d01e495e89a00c6f4a4fb5b

  - name: lotti
    buildsystem: simple
    build-options:
      strip: true
      no-debuginfo: true
    build-commands:
      - echo "Installing Flutter bundle..."
      - cp -r flutter-bundle/* /app/
      - chmod +x /app/lotti
      - echo "Creating lib directory for additional libraries..."
      - mkdir -p /app/lib/ffmpeg
      # Note: libmpv is not included in this Flatpak build
      # The app should detect missing libmpv and degrade gracefully or show clear errors
      # This prevents shipping fake libraries that could cause hard-to-diagnose runtime issues
      - echo "Creating wrapper script to set library search path..."
      - |
        cat > /app/lotti-wrapper << 'EOF'
        #!/bin/bash
        export LD_LIBRARY_PATH=/app/lib:$LD_LIBRARY_PATH
        
        # Set GDK_BACKEND conditionally: prefer Wayland, fallback to X11 when needed
        if [ -z "$WAYLAND_DISPLAY" ] || [ "$XDG_SESSION_TYPE" != "wayland" ]; then
          # Fallback to X11 when Wayland is not available
          export GDK_BACKEND=x11
        fi
        # If Wayland is available, leave GDK_BACKEND unset to use Wayland by default
        
        cd /app
        exec ./lotti "$@"
        EOF
      - chmod +x /app/lotti-wrapper
      - echo "Wrapper script created with conditional GDK_BACKEND setting"
    sources:
      - type: dir
        path: flutter-bundle

  - name: flutter-common
    buildsystem: simple
    build-commands:
      - install -D com.matthiasnehlsen.lotti.desktop /app/share/applications/com.matthiasnehlsen.lotti.desktop
      - install -D com.matthiasnehlsen.lotti.generated.metainfo.xml /app/share/metainfo/com.matthiasnehlsen.lotti.metainfo.xml
      # Install icons with proper sizes (max 512x512)
      - install -D app_icon_512.png /app/share/icons/hicolor/512x512/apps/com.matthiasnehlsen.lotti.png
      - install -D app_icon_256.png /app/share/icons/hicolor/256x256/apps/com.matthiasnehlsen.lotti.png
      - install -D app_icon_128.png /app/share/icons/hicolor/128x128/apps/com.matthiasnehlsen.lotti.png
      - install -D app_icon_64.png /app/share/icons/hicolor/64x64/apps/com.matthiasnehlsen.lotti.png
      - install -D app_icon_48.png /app/share/icons/hicolor/48x48/apps/com.matthiasnehlsen.lotti.png
      - install -D app_icon_32.png /app/share/icons/hicolor/32x32/apps/com.matthiasnehlsen.lotti.png
      - install -D app_icon_16.png /app/share/icons/hicolor/16x16/apps/com.matthiasnehlsen.lotti.png
    sources:
      - type: file
        path: com.matthiasnehlsen.lotti.desktop
      - type: file
        path: com.matthiasnehlsen.lotti.generated.metainfo.xml
      - type: file
        path: app_icon_512.png
      - type: file
        path: app_icon_256.png
      - type: file
        path: app_icon_128.png
      - type: file
        path: app_icon_64.png
      - type: file
        path: app_icon_48.png
      - type: file
        path: app_icon_32.png
      - type: file
        path: app_icon_16.png